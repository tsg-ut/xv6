## メモリの話
一般的な話を書こうと思います。ここに書いているのはあくまでx86の話なのでx64など最近のCPUでは事情が違うので注意です。

### セグメント
* メモリを区画管理する方法の一つ。巨大なメモリをセグメントと呼ばれる単位に区切って管理する。

#### セグメントアドレスとオフセットアドレス
(図)

CPU内のアドレス変換回路がセグメントアドレスとオフセットアドレスの組からリニアアドレス(メモリの先頭から最後まで連続的に付くアドレスのようなものだが物理アドレスとは別)へ変換する。まずセグメントアドレスをセグメントベースと呼ばれるリニアアドレスの上位ビットのアドレスに変換し、これにオフセットアドレスを加算することでリニアアドレスを計算する。

#### セグメントレジスタ
メモリを指定するときは必ずセグメントレジスタとオフセットアドレスを指し示すレジスタの２つのレジスタを使う。セグメントレジスタとはセグメントを指し示すためのレジスタで、CS,DS,ES,SSなどの種類がある。
* プログラムの中では、セグメントレジスタを一回設定したら別のセグメントに移るまではオフセットアドレスのみでアドレスを指定する。
```
mov ax,0x(セグメントアドレス) //セグメントアドレスをセグメントレジスタにセットする
mov ds,ax

mov ax,0x(オフセットアドレス) //セグメントレジスタがセットされていたら、
mov ax,0x(オフセットアドレス) // 以降はオフセットアドレスのみでアドレスを指定する。
.
.
.
mov ax,0x(オフセットアドレス)

mov ax,0x(新しいセグメントアドレス) //セグメントを変更するときは新しいセグメントアドレスをセットする
mov ds,ax
```

* CSレジスタ
PC(プログラム・カウンタ)のセグメントレジスタ。EIPをオフセットレジスタとしてEIPと一緒に次実行する命令を指し示している。

* DSレジスタ
命令の実行によるメモリアクセス。

* SSレジスタ
スタックを指し示すセグメントレジスタ。


* 余談 64bit
x64では64ビットもあればメモリ空間なんて容易に指し示せるのでこんなものは無い。
リアルモード、プロテクトモードに加えてロングモードというものがあり、CSレジスタは今どのモードにいるかを指し示す役割をしている。32ビット互換のためでもある。
